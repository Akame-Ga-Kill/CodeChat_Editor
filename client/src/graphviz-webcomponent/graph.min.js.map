{"version":3,"file":"graph.min.js","sources":["../src/separate-engine.js","../src/graph.js"],"sourcesContent":["const { delayWorkerLoading } = window.graphvizWebComponent || {}\r\nlet renderer, rendererUrl\r\n\r\nif (!delayWorkerLoading) setTimeout(getRenderer)\r\n\r\nfunction ensureConfiguration () {\r\n  if (!rendererUrl) {\r\n    ({\r\n      rendererUrl = 'https://unpkg.com/graphviz-webcomponent@1.1.0/dist/renderer.min.js'\r\n    } = window.graphvizWebComponent || {})\r\n  }\r\n}\r\n\r\nexport default function getRenderer () {\r\n  if (!renderer) {\r\n    ensureConfiguration()\r\n    renderer = new Worker(rendererUrl)\r\n  }\r\n  return renderer\r\n}\r\n","import getRenderer from \"./separate-engine\";\r\n\r\nconst graphKey = Symbol(\"graph\");\r\nconst scaleKey = Symbol(\"scale\");\r\n// Use this to assign a unique ID to each render.\r\nlet render_id = Number.MIN_SAFE_INTEGER;\r\n\r\nfunction requestRendering(element, script, receiveResult) {\r\n  const renderer = getRenderer();\r\n  renderer.addEventListener(\"message\", receiveResult);\r\n  renderer.postMessage({ script: script || element.graph, render_id });\r\n  return render_id++;\r\n}\r\n\r\nfunction closeRendering(receiveResult) {\r\n  const renderer = getRenderer();\r\n  renderer.removeEventListener(\"message\", receiveResult);\r\n}\r\n\r\nfunction triggerEvent(element, type, detail) {\r\n  element.dispatchEvent(new CustomEvent(type, { detail }));\r\n}\r\n\r\nfunction applyScale(element) {\r\n  const svg = element.shadowRoot.children[0];\r\n  const scale = element.scale;\r\n  if (svg) {\r\n    if (scale) {\r\n      svg.style.transform = `scale(${scale})`;\r\n      svg.style.transformOrigin = \"top left\";\r\n    } else {\r\n      svg.style.transform = \"\";\r\n      svg.style.transformOrigin = \"\";\r\n    }\r\n  }\r\n}\r\n\r\nfunction showImage(element, svg) {\r\n  element.shadowRoot.innerHTML = svg;\r\n  applyScale(element);\r\n  triggerEvent(element, \"render\", svg);\r\n}\r\n\r\nfunction showError(element, error) {\r\n  console.error(\"Graphviz failed:\", error);\r\n  element.shadowRoot.innerHTML = error.message;\r\n  return triggerEvent(element, \"error\", error);\r\n}\r\n\r\nfunction updateGraph(element) {\r\n  return new Promise((resolve) => {\r\n    element.shadowRoot.innerHTML = \"\";\r\n    if (!element.graph) return resolve();\r\n    const assigned_render_id = requestRendering(\r\n      element,\r\n      undefined,\r\n      receiveResult\r\n    );\r\n\r\n    function receiveResult({ data }) {\r\n      const { svg, error, render_id } = data;\r\n      if (assigned_render_id !== render_id) {\r\n        // This render was for a different request. Ignore it.\r\n        return;\r\n      }\r\n      closeRendering(receiveResult);\r\n      if (error) {\r\n        error.message = error.message.trim();\r\n        showError(element, error);\r\n        return resolve(error);\r\n      }\r\n      showImage(element, svg);\r\n      resolve(svg);\r\n    }\r\n  });\r\n}\r\n\r\nfunction tryUpdateGraph(element, script) {\r\n  return new Promise((resolve, reject) => {\r\n    if (!script) {\r\n      element[graphKey] = \"\";\r\n      element.shadowRoot.innerHTML = \"\";\r\n      return resolve();\r\n    }\r\n    const assigned_render_id = requestRendering(element, script, receiveResult);\r\n\r\n    function receiveResult({ data }) {\r\n      const { svg, error, render_id } = data;\r\n      if (assigned_render_id !== render_id) {\r\n        // This render was for a different request. Ignore it.\r\n        return;\r\n      }\r\n      closeRendering(receiveResult);\r\n      if (error) return reject(error);\r\n      element[graphKey] = script;\r\n      showImage(element, svg);\r\n      resolve(svg);\r\n    }\r\n  });\r\n}\r\n\r\nclass GraphvizGraphElement extends HTMLElement {\r\n  constructor() {\r\n    super();\r\n    this.attachShadow({ mode: \"open\" });\r\n    this.graphCompleted = Promise.resolve();\r\n  }\r\n\r\n  get graph() {\r\n    return this[graphKey];\r\n  }\r\n  set graph(value) {\r\n    this.setAttribute(\"graph\", value);\r\n  }\r\n\r\n  get scale() {\r\n    return this[scaleKey];\r\n  }\r\n  set scale(value) {\r\n    this.setAttribute(\"scale\", value);\r\n  }\r\n\r\n  attributeChangedCallback(name, oldValue, newValue) {\r\n    switch (name) {\r\n      case \"graph\":\r\n        this[graphKey] = newValue;\r\n        this.graphCompleted = updateGraph(this).catch((error) => error);\r\n        break;\r\n      case \"scale\":\r\n        this[scaleKey] = newValue;\r\n        applyScale(this);\r\n    }\r\n  }\r\n\r\n  tryGraph(graph) {\r\n    const promise = tryUpdateGraph(this, graph);\r\n    this.graphCompleted = promise.catch((error) => error);\r\n    return promise;\r\n  }\r\n\r\n  static get observedAttributes() {\r\n    return [\"graph\", \"scale\"];\r\n  }\r\n}\r\n\r\ncustomElements.define(\"graphviz-graph\", GraphvizGraphElement);\r\n\r\nexport default GraphvizGraphElement;\r\n"],"names":["renderer","rendererUrl","delayWorkerLoading","window","graphvizWebComponent","getRenderer","Worker","setTimeout","graphKey","Symbol","scaleKey","render_id","Number","MIN_SAFE_INTEGER","requestRendering","element","script","receiveResult","addEventListener","postMessage","graph","closeRendering","removeEventListener","triggerEvent","type","detail","dispatchEvent","CustomEvent","applyScale","svg","shadowRoot","children","scale","style","transform","transformOrigin","showImage","innerHTML","GraphvizGraphElement","HTMLElement","constructor","attachShadow","mode","graphCompleted","Promise","resolve","value","setAttribute","attributeChangedCallback","name","oldValue","newValue","updateGraph","assigned_render_id","undefined","data","error","message","trim","console","catch","tryGraph","promise","reject","observedAttributes","customElements","define"],"mappings":"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"}