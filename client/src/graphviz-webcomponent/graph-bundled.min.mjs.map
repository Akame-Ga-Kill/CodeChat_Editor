{"version":3,"file":"graph-bundled.min.mjs","sources":["../src/bundled-engine.js","../src/graph.js"],"sourcesContent":["import rendererScript from '../dist/renderer.min.js'\r\n\r\nlet renderer\r\n\r\nexport default function getRenderer () {\r\n  if (!renderer) {\r\n    const rendererBlob = new Blob([rendererScript], { type: 'application/javascript' })\r\n    const rendererUrl = URL.createObjectURL(rendererBlob)\r\n    renderer = new Worker(rendererUrl)\r\n  }\r\n  return renderer\r\n}\r\n","import getRenderer from \"./separate-engine\";\r\n\r\nconst graphKey = Symbol(\"graph\");\r\nconst scaleKey = Symbol(\"scale\");\r\n// Use this to assign a unique ID to each render.\r\nlet render_id = Number.MIN_SAFE_INTEGER;\r\n\r\nfunction requestRendering(element, script, receiveResult) {\r\n  const renderer = getRenderer();\r\n  renderer.addEventListener(\"message\", receiveResult);\r\n  renderer.postMessage({ script: script || element.graph, render_id });\r\n  return render_id++;\r\n}\r\n\r\nfunction closeRendering(receiveResult) {\r\n  const renderer = getRenderer();\r\n  renderer.removeEventListener(\"message\", receiveResult);\r\n}\r\n\r\nfunction triggerEvent(element, type, detail) {\r\n  element.dispatchEvent(new CustomEvent(type, { detail }));\r\n}\r\n\r\nfunction applyScale(element) {\r\n  const svg = element.shadowRoot.children[0];\r\n  const scale = element.scale;\r\n  if (svg) {\r\n    if (scale) {\r\n      svg.style.transform = `scale(${scale})`;\r\n      svg.style.transformOrigin = \"top left\";\r\n    } else {\r\n      svg.style.transform = \"\";\r\n      svg.style.transformOrigin = \"\";\r\n    }\r\n  }\r\n}\r\n\r\nfunction showImage(element, svg) {\r\n  element.shadowRoot.innerHTML = svg;\r\n  applyScale(element);\r\n  triggerEvent(element, \"render\", svg);\r\n}\r\n\r\nfunction showError(element, error) {\r\n  console.error(\"Graphviz failed:\", error);\r\n  element.shadowRoot.innerHTML = error.message;\r\n  return triggerEvent(element, \"error\", error);\r\n}\r\n\r\nfunction updateGraph(element) {\r\n  return new Promise((resolve) => {\r\n    element.shadowRoot.innerHTML = \"\";\r\n    if (!element.graph) return resolve();\r\n    const assigned_render_id = requestRendering(\r\n      element,\r\n      undefined,\r\n      receiveResult\r\n    );\r\n\r\n    function receiveResult({ data }) {\r\n      const { svg, error, render_id } = data;\r\n      if (assigned_render_id !== render_id) {\r\n        // This render was for a different request. Ignore it.\r\n        return;\r\n      }\r\n      closeRendering(receiveResult);\r\n      if (error) {\r\n        error.message = error.message.trim();\r\n        showError(element, error);\r\n        return resolve(error);\r\n      }\r\n      showImage(element, svg);\r\n      resolve(svg);\r\n    }\r\n  });\r\n}\r\n\r\nfunction tryUpdateGraph(element, script) {\r\n  return new Promise((resolve, reject) => {\r\n    if (!script) {\r\n      element[graphKey] = \"\";\r\n      element.shadowRoot.innerHTML = \"\";\r\n      return resolve();\r\n    }\r\n    const assigned_render_id = requestRendering(element, script, receiveResult);\r\n\r\n    function receiveResult({ data }) {\r\n      const { svg, error, render_id } = data;\r\n      if (assigned_render_id !== render_id) {\r\n        // This render was for a different request. Ignore it.\r\n        return;\r\n      }\r\n      closeRendering(receiveResult);\r\n      if (error) return reject(error);\r\n      element[graphKey] = script;\r\n      showImage(element, svg);\r\n      resolve(svg);\r\n    }\r\n  });\r\n}\r\n\r\nclass GraphvizGraphElement extends HTMLElement {\r\n  constructor() {\r\n    super();\r\n    this.attachShadow({ mode: \"open\" });\r\n    this.graphCompleted = Promise.resolve();\r\n  }\r\n\r\n  get graph() {\r\n    return this[graphKey];\r\n  }\r\n  set graph(value) {\r\n    this.setAttribute(\"graph\", value);\r\n  }\r\n\r\n  get scale() {\r\n    return this[scaleKey];\r\n  }\r\n  set scale(value) {\r\n    this.setAttribute(\"scale\", value);\r\n  }\r\n\r\n  attributeChangedCallback(name, oldValue, newValue) {\r\n    switch (name) {\r\n      case \"graph\":\r\n        this[graphKey] = newValue;\r\n        this.graphCompleted = updateGraph(this).catch((error) => error);\r\n        break;\r\n      case \"scale\":\r\n        this[scaleKey] = newValue;\r\n        applyScale(this);\r\n    }\r\n  }\r\n\r\n  tryGraph(graph) {\r\n    const promise = tryUpdateGraph(this, graph);\r\n    this.graphCompleted = promise.catch((error) => error);\r\n    return promise;\r\n  }\r\n\r\n  static get observedAttributes() {\r\n    return [\"graph\", \"scale\"];\r\n  }\r\n}\r\n\r\ncustomElements.define(\"graphviz-graph\", GraphvizGraphElement);\r\n\r\nexport default GraphvizGraphElement;\r\n"],"names":["renderer","getRenderer","rendererBlob","Blob","rendererScript","type","rendererUrl","URL","createObjectURL","Worker","graphKey","Symbol","scaleKey","render_id","Number","MIN_SAFE_INTEGER","requestRendering","element","script","receiveResult","addEventListener","postMessage","graph","closeRendering","removeEventListener","triggerEvent","detail","dispatchEvent","CustomEvent","applyScale","svg","shadowRoot","children","scale","style","transform","transformOrigin","showImage","innerHTML","showError","error","console","message","updateGraph","Promise","resolve","assigned_render_id","undefined","data","trim","tryUpdateGraph","reject","GraphvizGraphElement","HTMLElement","constructor","attachShadow","mode","graphCompleted","value","setAttribute","attributeChangedCallback","name","oldValue","newValue","catch","tryGraph","promise","observedAttributes","customElements","define"],"mappings":"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"}