{"version":3,"file":"graph.min.mjs","sources":["../src/separate-engine.js","../src/graph.js"],"sourcesContent":["const { delayWorkerLoading } = window.graphvizWebComponent || {}\r\nlet renderer, rendererUrl\r\n\r\nif (!delayWorkerLoading) setTimeout(getRenderer)\r\n\r\nfunction ensureConfiguration () {\r\n  if (!rendererUrl) {\r\n    ({\r\n      rendererUrl = 'https://unpkg.com/graphviz-webcomponent@1.1.0/dist/renderer.min.js'\r\n    } = window.graphvizWebComponent || {})\r\n  }\r\n}\r\n\r\nexport default function getRenderer () {\r\n  if (!renderer) {\r\n    ensureConfiguration()\r\n    renderer = new Worker(rendererUrl)\r\n  }\r\n  return renderer\r\n}\r\n","import getRenderer from \"./separate-engine\";\r\n\r\nconst graphKey = Symbol(\"graph\");\r\nconst scaleKey = Symbol(\"scale\");\r\n// Use this to assign a unique ID to each render.\r\nlet render_id = Number.MIN_SAFE_INTEGER;\r\n\r\nfunction requestRendering(element, script, receiveResult) {\r\n  const renderer = getRenderer();\r\n  renderer.addEventListener(\"message\", receiveResult);\r\n  renderer.postMessage({ script: script || element.graph, render_id });\r\n  return render_id++;\r\n}\r\n\r\nfunction closeRendering(receiveResult) {\r\n  const renderer = getRenderer();\r\n  renderer.removeEventListener(\"message\", receiveResult);\r\n}\r\n\r\nfunction triggerEvent(element, type, detail) {\r\n  element.dispatchEvent(new CustomEvent(type, { detail }));\r\n}\r\n\r\nfunction applyScale(element) {\r\n  const svg = element.shadowRoot.children[0];\r\n  const scale = element.scale;\r\n  if (svg) {\r\n    if (scale) {\r\n      svg.style.transform = `scale(${scale})`;\r\n      svg.style.transformOrigin = \"top left\";\r\n    } else {\r\n      svg.style.transform = \"\";\r\n      svg.style.transformOrigin = \"\";\r\n    }\r\n  }\r\n}\r\n\r\nfunction showImage(element, svg) {\r\n  element.shadowRoot.innerHTML = svg;\r\n  applyScale(element);\r\n  triggerEvent(element, \"render\", svg);\r\n}\r\n\r\nfunction showError(element, error) {\r\n  console.error(\"Graphviz failed:\", error);\r\n  element.shadowRoot.innerHTML = error.message;\r\n  return triggerEvent(element, \"error\", error);\r\n}\r\n\r\nfunction updateGraph(element) {\r\n  return new Promise((resolve) => {\r\n    element.shadowRoot.innerHTML = \"\";\r\n    if (!element.graph) return resolve();\r\n    const assigned_render_id = requestRendering(\r\n      element,\r\n      undefined,\r\n      receiveResult\r\n    );\r\n\r\n    function receiveResult({ data }) {\r\n      const { svg, error, render_id } = data;\r\n      if (assigned_render_id !== render_id) {\r\n        // This render was for a different request. Ignore it.\r\n        return;\r\n      }\r\n      closeRendering(receiveResult);\r\n      if (error) {\r\n        error.message = error.message.trim();\r\n        showError(element, error);\r\n        return resolve(error);\r\n      }\r\n      showImage(element, svg);\r\n      resolve(svg);\r\n    }\r\n  });\r\n}\r\n\r\nfunction tryUpdateGraph(element, script) {\r\n  return new Promise((resolve, reject) => {\r\n    if (!script) {\r\n      element[graphKey] = \"\";\r\n      element.shadowRoot.innerHTML = \"\";\r\n      return resolve();\r\n    }\r\n    const assigned_render_id = requestRendering(element, script, receiveResult);\r\n\r\n    function receiveResult({ data }) {\r\n      const { svg, error, render_id } = data;\r\n      if (assigned_render_id !== render_id) {\r\n        // This render was for a different request. Ignore it.\r\n        return;\r\n      }\r\n      closeRendering(receiveResult);\r\n      if (error) return reject(error);\r\n      element[graphKey] = script;\r\n      showImage(element, svg);\r\n      resolve(svg);\r\n    }\r\n  });\r\n}\r\n\r\nclass GraphvizGraphElement extends HTMLElement {\r\n  constructor() {\r\n    super();\r\n    this.attachShadow({ mode: \"open\" });\r\n    this.graphCompleted = Promise.resolve();\r\n  }\r\n\r\n  get graph() {\r\n    return this[graphKey];\r\n  }\r\n  set graph(value) {\r\n    this.setAttribute(\"graph\", value);\r\n  }\r\n\r\n  get scale() {\r\n    return this[scaleKey];\r\n  }\r\n  set scale(value) {\r\n    this.setAttribute(\"scale\", value);\r\n  }\r\n\r\n  attributeChangedCallback(name, oldValue, newValue) {\r\n    switch (name) {\r\n      case \"graph\":\r\n        this[graphKey] = newValue;\r\n        this.graphCompleted = updateGraph(this).catch((error) => error);\r\n        break;\r\n      case \"scale\":\r\n        this[scaleKey] = newValue;\r\n        applyScale(this);\r\n    }\r\n  }\r\n\r\n  tryGraph(graph) {\r\n    const promise = tryUpdateGraph(this, graph);\r\n    this.graphCompleted = promise.catch((error) => error);\r\n    return promise;\r\n  }\r\n\r\n  static get observedAttributes() {\r\n    return [\"graph\", \"scale\"];\r\n  }\r\n}\r\n\r\ncustomElements.define(\"graphviz-graph\", GraphvizGraphElement);\r\n\r\nexport default GraphvizGraphElement;\r\n"],"names":["renderer","rendererUrl","delayWorkerLoading","window","graphvizWebComponent","ensureConfiguration","getRenderer","Worker","setTimeout","graphKey","Symbol","scaleKey","render_id","Number","MIN_SAFE_INTEGER","requestRendering","element","script","receiveResult","addEventListener","postMessage","graph","closeRendering","removeEventListener","triggerEvent","type","detail","dispatchEvent","CustomEvent","applyScale","svg","shadowRoot","children","scale","style","transform","transformOrigin","showImage","innerHTML","showError","error","console","message","updateGraph","Promise","resolve","assigned_render_id","undefined","data","trim","tryUpdateGraph","reject","GraphvizGraphElement","HTMLElement","constructor","attachShadow","mode","graphCompleted","value","setAttribute","attributeChangedCallback","name","oldValue","newValue","catch","tryGraph","promise","observedAttributes","customElements","define"],"mappings":"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"}